{% extends "base.html" %}

{% block title %}Analytics & Insights - Austrian Research Metadata Platform{% endblock %}

{% block content %}
<main class="min-h-screen bg-gray-50 py-12">
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
    <!-- Header -->
    <div class="mb-12">
      <h1 class="text-4xl font-bold text-gray-900 mb-4">Research Analytics</h1>
      <p class="text-xl text-gray-600">
        Comprehensive insights into Austrian research trends, impact metrics, and collaboration networks.
      </p>
    </div>

    <!-- Tabs -->
    <div class="flex flex-wrap gap-2 mb-8 border-b border-gray-200" x-data="{ activeTab: 'trends' }">
      <button @click="activeTab='trends'" :class="activeTab === 'trends' ? 'border-b-2 border-blue-600 text-blue-600' : 'text-gray-600 hover:text-gray-900'" class="px-4 py-2 font-medium">
        Research Trends
      </button>
      <button @click="activeTab='impact'" :class="activeTab === 'impact' ? 'border-b-2 border-blue-600 text-blue-600' : 'text-gray-600 hover:text-gray-900'" class="px-4 py-2 font-medium">
        Researcher Impact
      </button>
      <button @click="activeTab='openaccess'" :class="activeTab === 'openaccess' ? 'border-b-2 border-blue-600 text-blue-600' : 'text-gray-600 hover:text-gray-900'" class="px-4 py-2 font-medium">
        Open Access Evolution
      </button>
      <button @click="activeTab='types'" :class="activeTab === 'types' ? 'border-b-2 border-blue-600 text-blue-600' : 'text-gray-600 hover:text-gray-900'" class="px-4 py-2 font-medium">
        Publication Types
      </button>
      <button @click="activeTab='comparison'" :class="activeTab === 'comparison' ? 'border-b-2 border-blue-600 text-blue-600' : 'text-gray-600 hover:text-gray-900'" class="px-4 py-2 font-medium">
        Organization Comparison
      </button>
    </div>

    <!-- Content -->
    <div x-data="{ activeTab: 'trends', loading: false, data: {} }">

      <!-- Research Trends Tab -->
      <section x-show="activeTab === 'trends'" class="space-y-6">
        <div class="bg-white rounded-lg shadow p-6">
          <h2 class="text-2xl font-bold text-gray-900 mb-4">Publication Trends Over Time</h2>
          <div id="trendsChart" style="min-height: 400px;" class="mb-4">
            <canvas id="trendCanvas"></canvas>
          </div>
          <div class="text-sm text-gray-600">
            View the evolution of research output and open access adoption over time.
          </div>
        </div>
      </section>

      <!-- Impact Tab -->
      <section x-show="activeTab === 'impact'" class="space-y-6">
        <div class="bg-white rounded-lg shadow p-6">
          <h2 class="text-2xl font-bold text-gray-900 mb-4">Top Researchers by Impact</h2>
          <div id="impactTable" class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
              <thead class="bg-gray-50">
                <tr>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase">Researcher</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase">Organization</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase">Publications</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase">Open Access</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase">H-Index</th>
                </tr>
              </thead>
              <tbody class="divide-y divide-gray-200">
                <tr class="hover:bg-gray-50">
                  <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">Loading...</td>
                  <td></td>
                  <td></td>
                  <td></td>
                  <td></td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- Open Access Evolution Tab -->
      <section x-show="activeTab === 'openaccess'" class="space-y-6">
        <div class="bg-white rounded-lg shadow p-6">
          <h2 class="text-2xl font-bold text-gray-900 mb-4">Open Access Adoption Trends</h2>
          <div id="oaChart" style="min-height: 400px;">
            <canvas id="oaCanvas"></canvas>
          </div>
          <div class="text-sm text-gray-600 mt-4">
            Track the increasing percentage of openly accessible research publications over time.
          </div>
        </div>
      </section>

      <!-- Publication Types Tab -->
      <section x-show="activeTab === 'types'" class="space-y-6">
        <div class="bg-white rounded-lg shadow p-6">
          <h2 class="text-2xl font-bold text-gray-900 mb-4">Publication Type Distribution</h2>
          <div id="typesChart" style="min-height: 400px;">
            <canvas id="typesCanvas"></canvas>
          </div>
          <div class="text-sm text-gray-600 mt-4">
            Distribution of research across different publication types (articles, books, datasets, etc.).
          </div>
        </div>
      </section>

      <!-- Organization Comparison Tab -->
      <section x-show="activeTab === 'comparison'" class="space-y-6">
        <div class="bg-white rounded-lg shadow p-6">
          <h2 class="text-2xl font-bold text-gray-900 mb-4">Organization Comparison</h2>

          <div class="mb-6">
            <label class="block text-sm font-medium text-gray-700 mb-2">Select Organizations</label>
            <div class="flex gap-2 flex-wrap">
              <label class="inline-flex items-center">
                <input type="checkbox" class="org-select" value="03prydq77" class="h-4 w-4 text-blue-600">
                <span class="ml-2 text-sm text-gray-600">University of Vienna</span>
              </label>
              <label class="inline-flex items-center">
                <input type="checkbox" class="org-select" value="05qghxh33" class="h-4 w-4 text-blue-600">
                <span class="ml-2 text-sm text-gray-600">TU Wien</span>
              </label>
              <label class="inline-flex items-center">
                <input type="checkbox" class="org-select" value="035xkbk20" class="h-4 w-4 text-blue-600">
                <span class="ml-2 text-sm text-gray-600">University of Graz</span>
              </label>
            </div>
          </div>

          <div id="comparisonTable" class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
              <thead class="bg-gray-50">
                <tr>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase">Organization</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase">Publications</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase">Open Access %</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase">Researchers</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase">Avg/Researcher</th>
                </tr>
              </thead>
              <tbody class="divide-y divide-gray-200">
                <tr class="hover:bg-gray-50">
                  <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">Select organizations above</td>
                  <td></td>
                  <td></td>
                  <td></td>
                  <td></td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </section>

    </div>

    <!-- Info Cards -->
    <div class="mt-12 grid grid-cols-1 md:grid-cols-3 gap-6">
      <div class="bg-gradient-to-br from-blue-50 to-blue-100 rounded-lg shadow p-6">
        <h3 class="text-lg font-semibold text-blue-900 mb-2">Research Insights</h3>
        <p class="text-blue-800">
          Explore trends in publication, funding, and research impact across Austrian institutions.
        </p>
      </div>

      <div class="bg-gradient-to-br from-green-50 to-green-100 rounded-lg shadow p-6">
        <h3 class="text-lg font-semibold text-green-900 mb-2">Open Access Growth</h3>
        <p class="text-green-800">
          Track the adoption of open access publishing practices among Austrian researchers.
        </p>
      </div>

      <div class="bg-gradient-to-br from-purple-50 to-purple-100 rounded-lg shadow p-6">
        <h3 class="text-lg font-semibold text-purple-900 mb-2">Collaboration Networks</h3>
        <p class="text-purple-800">
          Discover co-author networks and research collaborations across the country.
        </p>
      </div>
    </div>

  </div>
</main>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
<script>
  // Analytics dashboard initialization
  document.addEventListener('DOMContentLoaded', function() {
    // Load trends data
    fetch('/api/analytics/trends')
      .then(r => r.json())
      .then(data => renderTrendsChart(data))
      .catch(e => console.error('Error loading trends:', e));

    // Load impact data
    fetch('/api/analytics/impact?limit=10')
      .then(r => r.json())
      .then(data => renderImpactTable(data))
      .catch(e => console.error('Error loading impact:', e));

    // Load OA evolution
    fetch('/api/analytics/open-access')
      .then(r => r.json())
      .then(data => renderOAChart(data))
      .catch(e => console.error('Error loading OA:', e));

    // Load publication types
    fetch('/api/analytics/publication-types')
      .then(r => r.json())
      .then(data => renderTypesChart(data))
      .catch(e => console.error('Error loading types:', e));
  });

  function renderTrendsChart(data) {
    const years = data.trends.map(t => t.year);
    const publications = data.trends.map(t => t.publications);
    const openAccess = data.trends.map(t => t.open_access);

    new Chart(document.getElementById('trendCanvas'), {
      type: 'line',
      data: {
        labels: years,
        datasets: [
          {
            label: 'Total Publications',
            data: publications,
            borderColor: '#3b82f6',
            backgroundColor: 'rgba(59, 130, 246, 0.1)',
            tension: 0.4,
            yAxisID: 'y'
          },
          {
            label: 'Open Access',
            data: openAccess,
            borderColor: '#10b981',
            backgroundColor: 'rgba(16, 185, 129, 0.1)',
            tension: 0.4,
            yAxisID: 'y1'
          }
        ]
      },
      options: {
        responsive: true,
        interaction: { mode: 'index', intersect: false },
        scales: {
          y: { type: 'linear', display: true, position: 'left' },
          y1: { type: 'linear', display: true, position: 'right', grid: { drawOnChartArea: false } }
        }
      }
    });
  }

  function renderOAChart(data) {
    const years = data.open_access_evolution.map(t => t.year);
    const oa_pct = data.open_access_evolution.map(t => t.open_access_percentage);

    new Chart(document.getElementById('oaCanvas'), {
      type: 'bar',
      data: {
        labels: years,
        datasets: [{
          label: 'Open Access %',
          data: oa_pct,
          backgroundColor: '#10b981',
          borderColor: '#059669',
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        scales: {
          y: { beginAtZero: true, max: 100 }
        }
      }
    });
  }

  function renderTypesChart(data) {
    const types = data.publication_types.map(t => t.type);
    const counts = data.publication_types.map(t => t.count);
    const colors = ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#ec4899'];

    new Chart(document.getElementById('typesCanvas'), {
      type: 'doughnut',
      data: {
        labels: types,
        datasets: [{
          data: counts,
          backgroundColor: colors
        }]
      },
      options: {
        responsive: true,
        plugins: {
          legend: { position: 'bottom' }
        }
      }
    });
  }

  function renderImpactTable(data) {
    const tbody = document.querySelector('#impactTable tbody');
    tbody.innerHTML = data.top_researchers.map(r => `
      <tr class="hover:bg-gray-50">
        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${r.name}</td>
        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">${r.organization?.name || '-'}</td>
        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 font-medium">${r.metrics.publications}</td>
        <td class="px-6 py-4 whitespace-nowrap text-sm">
          <span class="bg-green-100 text-green-800 px-2 py-1 rounded">${r.metrics.open_access_pct}%</span>
        </td>
        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">${r.metrics.h_index || '-'}</td>
      </tr>
    `).join('');
  }
</script>
{% endblock %}
